<?xml version="1.0" encoding="UTF-8"?>
<project name="" basedir="." default="...">    
    



    <!-- ==================================== -->
    <!--             Dependencies             -->
    <!-- ==================================== -->




    <import file="${phingy.path}/scripts/core/database.xml" />




    <!-- ==================================== -->
    <!--              Properties              -->
    <!-- ==================================== -->
    



    <property name="build.library_dir" value="${build.path}/library" />
    <property name="typo3.index_file" value="t3index.php" />
    <property name="amazon.key" value="${s3.key}" />
    <property name="amazon.secret" value="${s3.secret}" />

    <!-- Set the include path -->
    <includepath classpath="./library" />




    <!-- ==================================== -->
    <!--                Tasks                 -->
    <!-- ==================================== -->




    <!--
        Required Typo3 configuration
    -->
    <target name="typo3:need_configuration" hidden="true">
        <if>
            <and>
                <isset property="typo3.source" />
                <isset property="typo3.index_file" />
                <isset property="build.library_dir" />
            </and>
            <then>
                <property name="typo3.is_configured" value="true" />
            </then>
            <else>
                <property name="typo3.is_configured" value="false" />
                <phingcall target="typo3:build:config" />
            </else>
        </if>
    </target>
    

    <!--
        Setup Typo3 config
    -->
    <target name="typo3:build:config" description="Configure Typo3 Build" depends="db:build:config" hidden="true">
        <echo msg="Configuring Typo3 ================================" />

        <exec
            command="find ${share.path}/ -name 'typo3_src*' ! -name '*.gz' | cut -f 2- -d - | awk '{print $1&#34;,&#34; }' | tr -d '\n' | rev | cut -b 2- | rev"
            escape="false"
            outputproperty="typo3.versions"
        />

        <input propertyname="typo3.source" defaultValue="6.1.3" validargs="${typo3.versions}" promptChar=" ?">Typo3 source</input>

        <phingcall target="build:save_config" />
    </target>
    

    <!--
        Sets up the directories and permissions required by TYPO3.
        Symlinks TYPO3 into this environment. 
    -->
    <target name="typo3:build:before" hidden="true" depends="typo3:need_configuration">
        <mkdir dir="${build.public_dir}/typo3temp" />
        <mkdir dir="${build.public_dir}/typo3temp/Cache/Code/cache_phpcode" />
                
        <chmod file="${build.public_dir}/uploads" mode="0775" />
        <chmod file="${build.public_dir}/typo3temp" mode="0777" />
        <chmod file="${build.public_dir}/typo3temp/Cache" mode="0777" />
        <chmod file="${build.public_dir}/typo3temp/Cache/Code" mode="0777" />
        <chmod file="${build.public_dir}/typo3temp/Cache/Code/cache_phpcode" mode="0777" />
        <chmod file="${build.public_dir}/typo3conf" mode="0777" />
        <chmod file="${build.public_dir}/typo3conf/ext" mode="0777" />
        
        <phingcall target="typo3:symlink" />
    </target>
    

    <!--
        After build. Caches routes.
    -->
    <target name="typo3:build:after" hidden="true">
        <if>
            <equals arg1="${build.environment}" arg2="development" />
            <then>
                <echo msg="Development mode, updating database" />
                <phingcall target="db:update" />
            </then>
            <else>
                <echo msg="Production mode, not updating database" />
            </else>
        </if>
        
        <phingcall target="typo3:cache:routes" />
    </target>


    <!--
        Housekeeping. Nothing here yet.
    -->
    <target name="typo3:build:housekeeping" hidden="true">
        <echo message="Not used" />
    </target>
    

    <!-- 
        Generates the requried typo3 symlinks
    -->
    <target name="typo3:symlink" depends="typo3:need_configuration" description="Generates the required typo3 symlinks" hidden="true">
        <delete file="${build.public_dir}/${typo3.index_file}" />
        <delete file="${build.public_dir}/t3lib" />
        <delete file="${build.public_dir}/typo3" />
        <delete file="${build.public_dir}/typo3src" />

        <symlink target="${share.path}/typo3_src-${typo3.source}" link="${build.public_dir}/typo3src" />
        <symlink target="${build.public_dir}/typo3src/index.php" link="${build.public_dir}/${typo3.index_file}" />
        <symlink target="${build.public_dir}/typo3src/t3lib" link="${build.public_dir}/t3lib" />
        <symlink target="${build.public_dir}/typo3src/typo3" link="${build.public_dir}/typo3" />
    </target>


    <!-- 
        Creates the ENABLE_INSTALL_TOOL file
    -->
    <target name="typo3:install_tool:enable" depends="typo3:need_configuration" description="Creates the ENABLE_INSTALL_TOOL file">
        <touch file="${build.public_dir}/typo3conf/ENABLE_INSTALL_TOOL" />
    </target>


    <!-- 
        Removes the ENABLE_INSTALL_TOOL file
    -->
    <target name="typo3:install_tool:disable" depends="typo3:need_configuration" description="Removes the ENABLE_INSTALL_TOOL file">
        <delete file="${build.public_dir}/typo3conf/ENABLE_INSTALL_TOOL" />
    </target>
    

    <!-- 
        Cache MCA routes so Zend works inside TYPO3.
    -->
    <target name="typo3:cache:routes" depends="typo3:need_configuration" description="Cache MCA routes">
        <exec command="htdocs/typo3/cli_dispatch.phpsh tx_zendfe_cacheroutes" escape="false" passthru="true" />
    </target>


    <!--
        Clear all Typo3 caches
    -->
    <target name="typo3:cache:clear_all" depends="typo3:need_configuration" description="Completely clear TYPO3 temp and routing caches">
        <exec command="sudo rm htdocs/typo3temp/*" escape="false" />
        <exec command="sudo rm htdocs/typo3conf/realurl_autoconf.php" escape="false" />
    </target>


    <!--
        Clear cached config
    -->
    <target name="typo3:cache:clear_config" depends="typo3:need_configuration" description="Clear cached TYPO3 config">
        <exec command="sudo rm htdocs/typo3conf/Cache/Code/cache_core/ext_*" escape="false" />
        <exec command="sudo rm htdocs/typo3conf/Cache/Code/cache_core/tca_*" escape="false" />
        <exec command="sudo rm htdocs/typo3temp/config_cache*" escape="false" />
    </target>


    <!--
        Clear cached routing
    -->
    <target name="typo3:cache:clear_routes" depends="typo3:need_configuration" description="Clear cached TYPO3 routing">
        <exec command="sudo rm htdocs/typo3conf/realurl_autoconf.php" escape="false" />
        <exec command="sudo rm htdocs/typo3temp/routes.ini" escape="false" />
    </target>




</project>
